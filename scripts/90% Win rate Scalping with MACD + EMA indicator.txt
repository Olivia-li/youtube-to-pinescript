//@version=4
strategy("MACD and EMA Trading Strategy", overlay=true)

//Input variables
fastLength = input(title="Fast Length", type=input.integer, defval=12)
slowLength = input(title="Slow Length", type=input.integer, defval=26)
signalLength = input(title="Signal Smoothing", type=input.integer, defval=9)
emaLength = input(title="EMA Length", type=input.integer, defval=20)
stopLossPct = input(title="Stop Loss %", type=input.float, step=0.1, defval=1.0)
takeProfitPct = input(title="Take Profit %", type=input.float, step=0.1, defval=2.0)

//Calculate MACD and EMA
[macdLine, signalLine, _] = macd(close, fastLength, slowLength, signalLength)
emaLine = ema(close, emaLength)

//Plot MACD and EMA
plot(macdLine, color=color.blue, title="MACD")
plot(signalLine, color=color.orange, title="Signal Line")
plot(emaLine, color=color.red, title="EMA")

//Buy signal
buySignal = crossover(macdLine, signalLine) and close > emaLine

//Sell signal
sellSignal = crossunder(macdLine, signalLine) and close < emaLine

//Exit signal
exitSignal = sellSignal or buySignal

//Stop loss and take profit
stopLoss = close * (1 - stopLossPct/100)
takeProfit = close * (1 + takeProfitPct/100)

//Strategy entry and exit
if (buySignal)
    strategy.entry("Buy", strategy.long)
    strategy.exit("Exit", "Buy", stop=stopLoss, limit=takeProfit)
if (sellSignal)
    strategy.entry("Sell", strategy.short)
    strategy.exit("Exit", "Sell", stop=stopLoss, limit=takeProfit) 

//Plot stop loss and take profit levels
plot(stopLoss, color=color.red, title="Stop Loss")
plot(takeProfit, color=color.green, title="Take Profit") 

//Strategy backtesting settings
strategy.risk.allow_entry_in(strategy.direction.long)
strategy.risk.allow_entry_in(strategy.direction.short)
strategy.risk.max_intraday_drawdown_percent(10) //Maximum drawdown allowed
strategy.risk.max_position_size(100) //Maximum position size allowed
strategy.risk.percentage(2) //Risk percentage per trade

//Strategy performance report
strategy.performanceReport()